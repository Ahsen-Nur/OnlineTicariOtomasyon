using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore; // DbUpdateException
using MVCTicariOtomasyonWeb.Models.sƒ±nƒ±flar;
using System;
using System.Linq;

namespace MVCTicariOtomasyonWeb.Controllers
{
    public class KategoriController : Controller
    {
        private readonly Context _context;

        public KategoriController(Context context)
        {
            _context = context;
        }

        // üîπ Kategorileri Listele
        public IActionResult Index()
        {
            // Performans i√ßin takip etmeyelim; sadece listeleme
            var kategoriler = _context.Kategoris
                                      .AsNoTracking()
                                      .OrderBy(k => k.KategoriId)
                                      .ToList();
            return View(kategoriler);
        }

        // üîπ Yeni kategori ekleme formu (GET)
        [HttpGet]
        public IActionResult YeniKategori()
        {
            return View();
        }

        // üîπ Formdan gelen veriyi kaydet (POST)
        [HttpPost]
        [ValidateAntiForgeryToken]
        public IActionResult YeniKategori(Kategori k)
        {
            // Sunucu tarafƒ± ekstra koruma: bo≈ü/whitespace gelmesini engelle
            if (!string.IsNullOrWhiteSpace(k?.KategoriAd))
            {
                k.KategoriAd = k.KategoriAd.Trim();
            }

            if (!ModelState.IsValid)
            {
                // Hangi alan ve neden hatalƒ±? G√∂r√ºn√ºr kƒ±lalƒ±m.
                var errors = ModelState
                    .Where(x => x.Value!.Errors.Count > 0)
                    .Select(x => $"{x.Key}: {string.Join(", ", x.Value!.Errors.Select(e => string.IsNullOrEmpty(e.ErrorMessage) ? e.Exception?.Message : e.ErrorMessage))}");

                TempData["ModelErrors"] = string.Join(" | ", errors);
                Console.WriteLine("‚ùå Model hatalƒ±! " + TempData["ModelErrors"]);
                return View(k);
            }

            try
            {
                _context.Kategoris.Add(k);
                var affected = _context.SaveChanges();
                Console.WriteLine($"‚úÖ Kategori kaydedildi: {k.KategoriAd} (rows: {affected})");
                TempData["Success"] = $"Kategori eklendi: {k.KategoriAd}";
                return RedirectToAction(nameof(Index));
            }
            catch (DbUpdateException ex)
            {
                // √áoƒüunlukla burada: kolon uzunluƒüu, null constraint, FK/PK, baƒülantƒ± sorunlarƒ± vs.
                var root = ex.GetBaseException()?.Message ?? ex.Message;
                TempData["DbError"] = "Veritabanƒ±na kaydedilirken hata olu≈ütu: " + root;
                Console.WriteLine("‚ùå DbUpdateException: " + root);
                return View(k);
            }
            catch (Exception ex)
            {
                TempData["DbError"] = "Beklenmeyen bir hata olu≈ütu: " + ex.Message;
                Console.WriteLine("‚ùå Exception: " + ex);
                return View(k);
            }
        }

        // üîπ G√ºncelle (GET)
        [HttpGet]
        public IActionResult Guncelle(int id)
        {
            var kategori = _context.Kategoris.Find(id);
            if (kategori == null)
            {
                return NotFound();
            }
            return View(kategori);
        }

        // üîπ G√ºncelle (POST)
        [HttpPost]
        [ValidateAntiForgeryToken]
        public IActionResult Guncelle(Kategori k)
        {
            if (!string.IsNullOrWhiteSpace(k?.KategoriAd))
            {
                k.KategoriAd = k.KategoriAd.Trim();
            }

            if (!ModelState.IsValid)
            {
                var errors = ModelState
                    .Where(x => x.Value!.Errors.Count > 0)
                    .Select(x => $"{x.Key}: {string.Join(", ", x.Value!.Errors.Select(e => string.IsNullOrEmpty(e.ErrorMessage) ? e.Exception?.Message : e.ErrorMessage))}");
                TempData["ModelErrors"] = string.Join(" | ", errors);
                return View(k);
            }

            var mevcut = _context.Kategoris.Find(k.KategoriId);
            if (mevcut == null)
            {
                return NotFound();
            }

            try
            {
                mevcut.KategoriAd = k.KategoriAd;
                var affected = _context.SaveChanges();
                Console.WriteLine($"üìù Kategori g√ºncellendi: {mevcut.KategoriId} -> {mevcut.KategoriAd} (rows: {affected})");
                TempData["Success"] = "Kategori g√ºncellendi.";
                return RedirectToAction(nameof(Index));
            }
            catch (DbUpdateException ex)
            {
                var root = ex.GetBaseException()?.Message ?? ex.Message;
                TempData["DbError"] = "G√ºncelleme sƒ±rasƒ±nda hata: " + root;
                Console.WriteLine("‚ùå DbUpdateException: " + root);
                return View(k);
            }
        }

        // üîπ Sil (GET ‚Üí pratik; prod‚Äôda POST + AntiForgery tercih edilir)
        public IActionResult Sil(int id)
        {
            var kategori = _context.Kategoris.Find(id);
            if (kategori != null)
            {
                try
                {
                    _context.Kategoris.Remove(kategori);
                    var affected = _context.SaveChanges();
                    Console.WriteLine($"üóëÔ∏è Kategori silindi: {kategori.KategoriId} (rows: {affected})");
                    TempData["Success"] = "Kategori silindi.";
                }
                catch (DbUpdateException ex)
                {
                    var root = ex.GetBaseException()?.Message ?? ex.Message;
                    TempData["DbError"] = "Silme sƒ±rasƒ±nda hata: " + root;
                    Console.WriteLine("‚ùå DbUpdateException: " + root);
                }
            }
            return RedirectToAction(nameof(Index));
        }
    }
}
