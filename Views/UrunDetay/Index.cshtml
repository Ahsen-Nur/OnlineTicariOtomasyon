@model MVCTicariOtomasyonWeb.Models.ViewModels.UrunDetayViewModel
@{
    Layout = "~/Views/Shared/AdminLayout.cshtml";

    int? aktifCariId = Context.Session.GetInt32("CariId");
    string rol = Context.Session.GetString("Rol");
}

<div class="card shadow-sm">
    <div class="card-body">

        <div class="row">

            <!-- SOL: GÖRSEL -->
            <div class="col-md-4 text-center">
                <img src="@Model.Urun.UrunGorsel"
                     class="img-fluid rounded mb-3"
                     style="max-height:260px; object-fit:contain;" />

                @if (aktifCariId != null)
                {
                    <form method="post" action="/CariSatis/SatinAl" class="d-flex mt-2">
                        <input type="hidden" name="UrunId" value="@Model.Urun.UrunId" />

                        <div class="input-group mb-2">
                            <input type="number"
                                   name="Adet"
                                   value="1"
                                   min="1"
                                   max="@Model.Urun.Stok"
                                   class="form-control" />
                                   
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-cart-plus"></i> Satın Al
                            </button>
                        </div>
                    </form>
                }
                else
                {
                    <a href="/Login/GirisYap"
                       class="btn btn-outline-primary btn-block">
                        Satın almak için giriş yap
                    </a>
                }
            </div>

            <!-- SAĞ: BİLGİLER -->
            <div class="col-md-8">

                <h3 class="mb-0">@Model.Urun.UrunAd</h3>
                <small class="text-muted">@Model.Urun.Marka</small>

                <div class="h4 text-success mt-2">
                    @Model.Urun.SatisFiyat.ToString("N2") ₺
                </div>

                <div class="mt-1">
                    @if (Model.Urun.Stok == 0)
                    {
                        <span class="badge badge-danger">Stokta Yok</span>
                    }
                    else if (Model.Urun.Stok <= 5)
                    {
                        <span class="badge badge-warning">Kritik Stok (@Model.Urun.Stok)</span>
                    }
                    else
                    {
                        <span class="badge badge-success">Stokta Var (@Model.Urun.Stok)</span>
                    }
                </div>

                <hr />

                <!-- ÜRÜN ÖZELLİKLERİ -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Ürün Özellikleri</h5>
                    <a href="/UrunOzellik/Ekle/@Model.Urun.UrunId"
                       class="btn btn-sm btn-outline-primary">
                        + Özellik Ekle
                    </a>
                </div>

                @if (Model.Ozellikler.Any())
                {
                    var grupluOzellikler = Model.Ozellikler.GroupBy(x => x.Ozellik.OzellikAd);

                    foreach (var grup in grupluOzellikler)
                    {
                        <div class="mb-3">
                            <strong>@grup.Key</strong>

                            <div class="mt-2">
                                @foreach (var item in grup)
                                {
                                    <span class="badge badge-light border px-2 py-1 mr-1 text-dark">
                                        @item.Deger
                                    </span>
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted">Henüz özellik eklenmemiş.</p>
                }

                <hr />

                <!-- AÇIKLAMA -->
                <h5>Açıklama</h5>
                @if (!string.IsNullOrWhiteSpace(Model.Aciklama?.Metin))
                {
                    <p>@Model.Aciklama.Metin</p>
                }
                else
                {
                    <p class="text-muted">Açıklama girilmemiş.</p>
                }

                <hr />

                <!-- YORUMLAR -->
                <h5>Yorumlar</h5>

                <!-- YORUM YAPMA -->
                @if (ViewBag.YorumYetkisi == true)
                {
                    <div class="mb-4 p-3 border rounded bg-light">
                        <h6 class="mb-2">Yorum Yap</h6>

                        <form method="post" action="/UrunYorum/Ekle">
                            <input type="hidden" name="UrunId" value="@Model.Urun.UrunId" />

                            <div class="mb-2">
                                <label>Puan</label>
                                <select name="Puan" class="form-control form-control-sm" required>
                                    <option value="">Seçiniz</option>
                                    <option value="5">★★★★★</option>
                                    <option value="4">★★★★</option>
                                    <option value="3">★★★</option>
                                    <option value="2">★★</option>
                                    <option value="1">★</option>
                                </select>
                            </div>

                            <div class="mb-2">
                                <label>Yorum</label>
                                <textarea name="Yorum"
                                          class="form-control form-control-sm"
                                          rows="3"
                                          required></textarea>
                            </div>

                            <button type="submit" class="btn btn-success btn-sm">
                                Yorumu Gönder
                            </button>
                        </form>
                    </div>
                }
                else
                {
                    <p class="text-muted mb-3">
                        Bu ürünü satın alan kullanıcılar yorum yapabilir.
                    </p>
                }

                <!-- YORUM LİSTESİ -->
                @if (Model.Yorumlar.Any())
                {
                    foreach (var y in Model.Yorumlar)
                    {
                        <div class="mb-3 p-2 border rounded">
                            <strong>@y.KullaniciAd</strong>

                            <div>
                                @for (int i = 1; i <= 5; i++)
                                {
                                    <i class="@(i <= y.Puan ? "fas fa-star text-warning" : "far fa-star text-muted")"></i>
                                }
                            </div>

                            <small class="text-muted">@y.Tarih.ToShortDateString()</small>

                            <div class="mb-2">@y.Yorum</div>

                            @if (rol == "Admin" || (aktifCariId != null && y.CariId == aktifCariId))
                            {
                                <a href="/UrunYorum/Sil/@y.YorumId"
                                   class="btn btn-sm btn-danger"
                                   onclick="return confirm('Bu yorumu silmek istiyor musunuz?')">
                                    Yorumu Sil
                                </a>

                                <a href="/UrunYorum/Duzenle/@y.YorumId"
                                   class="btn btn-sm btn-warning ms-1">
                                    Düzenle
                                </a>
                            }
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted">Henüz yorum yapılmamış.</p>
                }

            </div>
        </div>

        <hr />

        <a href="/Urun/Index"
           class="btn btn-sm btn-outline-secondary">
            ← Ürün Listesine Dön
        </a>

    </div>
</div>
